---
date: 2019-06-29
title: "Curly-Curly, the successor of Bang-Bang"
tags: [R]
menu:
  main:
    parent: Blog
    identifier: /blog/tidy_eval_saga
    weight: 1
---

<div style="text-align:center;">
  <a href="https://en.wikipedia.org/wiki/Row_and_column_vectors">
    <img src="/img/curly.jpg" title = "Not that kind of columns" width="1119" height="720"></a>
</div>


Writing functions that take data frame columns as arguments is a problem that most R users have been
confronted with at some point. There are different ways to tackle this issue, and this blog post will
focus on the solution provided by the latest release of the `{rlang}` package. You can read the 
announcement [here](https://www.tidyverse.org/articles/2019/06/rlang-0-4-0/), which explains really
well what was wrong with the old syntax, and how the new syntax works now.

I have written about the problem of writing functions that use data frame columns as arguments
[three years ago](https://www.brodrigues.co/blog/2016-07-18-data-frame-columns-as-arguments-to-dplyr-functions/)
and [two year ago](https://www.brodrigues.co/blog/2017-08-27-why_tidyeval/) too.
[Last year](https://www.brodrigues.co/blog/2018-01-19-mapping_functions_with_any_cols/), I wrote a
blog post that showed how to map a list of functions to a list of datasets with a list of columns
as arguments that used the `!!quo(column_name)` syntax (the `!!` is pronounced *bang-bang*). 
Now, there is a new sheriff in town, `{{}}`, introduced in `{rlang}` version 0.4.0 that makes 
things even easier. The suggested pronunciation of `{{}}` is *curly-curly*, but there is no 
[consensus yet](https://twitter.com/JonTheGeek/status/1144815369766547456).

First, let's load the `{tidyverse}`:

```{r, include = FALSE}
library(tidyverse)
```

```{r, eval = FALSE}
library(tidyverse)
```

Let's suppose that I need to write a function that takes a data frame, as well as a column from 
this data frame as arguments:

```{r}
how_many_na <- function(dataframe, column_name){
  dataframe %>%
    filter(is.na(column_name)) %>%
    count()
}
```

Let's try this function out on the `starwars` data:

```{r}
data(starwars)

head(starwars)
```

As you can see, there are missing values in the `hair_color` column. Let's try to count how many
missing values are in this column:

```{r, eval=FALSE}
how_many_na(starwars, hair_color)
```

```
Error: object 'hair_color' not found
```

R cannot find the `hair_color` column, and yet it is in the data! Well, this is actually exactly
the issue. The issue is that the column is inside the dataframe, but when calling the function
with `hair_color` as the second argument, R is looking for a variable called `hair_color` that
does not exist. What about trying with `"hair_color"`?

```{r}
how_many_na(starwars, "hair_color")
```

Now we get something, but something wrong! 

One way to solve this issue, is to not use the `filter()` function, and instead rely on base R:

```{r}
how_many_na_base <- function(dataframe, column_name){
  na_index <- is.na(dataframe[, column_name])
  nrow(dataframe[na_index, column_name])
}

how_many_na_base(starwars, "hair_color")
```

This works, but not using the `{tidyverse}` at all is not an option, at least for me. For instance,
the next function, which uses a grouping variable, would be difficult to implement without the 
`{tidyverse}`:

```{r}
summarise_groups <- function(dataframe, grouping_var, column_name){
  dataframe %>%
    group_by(grouping_var) %>%  
    summarise(mean(column_name, na.rm = TRUE))
}
```

Calling this function results in the following error message:

```
Error: Column `grouping_var` is unknown
```

Before the release of `{rlang}` 0.4.0 this is was the solution:

```{r}
summarise_groups <- function(dataframe, grouping_var, column_name){

  grouping_var <- enquo(grouping_var)
  column_name <- enquo(column_name)
  mean_name <- paste0("mean_", quo_name(column_name))

  dataframe %>%
    group_by(!!grouping_var) %>%  
    summarise(!!(mean_name) := mean(!!column_name, na.rm = TRUE))
}
```

The core of the function remained very similar to the version from before, but now one has to 
use the `enquo()`-`!!` syntax. While not overly difficult to use, it is cumbersome.

Now this can be simplified using the new `{{}}` syntax:

```{r}
summarise_groups <- function(dataframe, grouping_var, column_name){

  dataframe %>%
    group_by({{grouping_var}}) %>%  
    summarise({{column_name}} := mean({{column_name}}, na.rm = TRUE))
}
```

Much easier and cleaner! You still have to use the `:=` operator instead of `=` for the column name
however. Also, from my understanding, if you want to modify the column names, for instance in this
case return `"mean_height"` instead of `height` you have to keep using the `enquo()`-`!!` syntax.



Hope you enjoyed! If you found this blog post useful, you might want to follow 
me on [twitter](https://www.twitter.com/brodriguesco) for blog post updates and 
[buy me an espresso](https://www.buymeacoffee.com/brodriguesco) or [paypal.me](https://www.paypal.me/brodriguesco).

<style>.bmc-button img{width: 27px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{line-height: 36px !important;height:37px !important;text-decoration: none !important;display:inline-flex !important;color:#ffffff !important;background-color:#272b30 !important;border-radius: 3px !important;border: 1px solid transparent !important;padding: 1px 9px !important;font-size: 22px !important;letter-spacing:0.6px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Cookie', cursive !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#82518c !important;}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet"><a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/brodriguesco"><img src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg" alt="Buy me an Espresso"><span style="margin-left:5px">Buy me an Espresso</span></a>
